<%# app/views/paths/new.html.erb - Themed form for creating a new Path %>

<% content_for :head do %>
  <%= stylesheet_link_tag "welcome", "data-turbo-track": "reload" %>
<% end %>

<%# The Canvas: Linked to the controller for the animation %>
<canvas id="particle-canvas" data-controller="welcome-background"></canvas>

<div id="welcome-screen">
  <div class="welcome-card" style="padding: 2rem 1.5rem;">

    <h1 style="color: var(--text-primary); margin-bottom: 20px; font-size: 2.5vh; flex-shrink: 0;">Create New Path</h1>

    <div class="welcome-form-wrapper">
      <%# The Rails form wrapper matches the styling of the wrapper div on other pages %>
      <%= form_with(model: @path) do |form| %>

        <% if @path.errors.any? %>
          <%# Using the shared error partial for consistency %>
          <%= render "devise/shared/error_messages", resource: @path %>
        <% end %>

        <div class="form-group">
          <%= form.text_field :name,
                              required: true,
                              placeholder: "Path Name (e.g. Deploy to Production)",
                              class: "welcome-input" %>
        </div>

        <div class="form-group">
          <%# For DateTime fields, browsers may display an unstyled native selector. %>
          <%# Use a wrapper for custom labeling if default isn't clear enough. %>
          <label style="color: var(--text-secondary); font-size: 0.9rem;">When to notify?</label>
          <%= form.datetime_field :strike_time,
                                  required: true,
                                  class: "welcome-input",
                                  style: "color-scheme: dark; padding: 0.8rem 1.2rem;" %>
        </div>

        <div class="form-group">
          <label style="color: var(--text-secondary); font-size: 0.9rem;">Target Devices</label>

          <% if @devices.any? %>
            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 5px;">
              <%# Iterate over current user's subscriptions %>
              <% current_user.web_push_subscriptions.each do |sub| %>
                <label style="display: flex; align-items: center; gap: 10px; color: var(--text-primary); cursor: pointer;">
                  <%# CHECKBOX LOGIC:
                      1. name="path[web_push_subscription_ids][]" allows passing multiple IDs as an array.
                      2. The third argument checks if the ID is already associated (for edit views or error re-renders).
                  %>
                  <%= check_box_tag "path[web_push_subscription_ids][]",
                                    sub.id,
                                    @path.web_push_subscription_ids.include?(sub.id),
                                    class: "welcome-input",
                                    style: "width: 20px; height: 20px; flex: 0 0 auto;" %>
                  <span><%= sub.device_name %></span>
                </label>
              <% end %>
            </div>
          <% else %>
            <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 5px; text-align: center;">
              <em>No devices registered.
                <%= link_to "Add one here", new_web_push_subscription_path, style: "color: var(--input-focus); font-weight: bold;" %>
              </em>
            </p>
          <% end %>
        </div>

        <div class="welcome-buttons-container" style="margin-top: 20px;">
          <%# Primary Action: Create Path %>
          <%= form.submit "CREATE PATH", class: "welcome-button solid-button" %>

          <%# Secondary Action: Back %>
          <%= link_to "BACK", paths_path, class: "welcome-button outline-button" %>
        </div>
      <% end %>
    </div>
  </div>
</div>