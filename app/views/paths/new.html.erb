<%# app/views/paths/new.html.erb - Themed form for creating a new Path %>

<% content_for :head do %>
  <%= stylesheet_link_tag "welcome", "data-turbo-track": "reload" %>
<% end %>

<%# The Canvas: Linked to the controller for the animation %>
<canvas id="particle-canvas" data-controller="welcome-background"></canvas>

<div id="welcome-screen">
  <div class="welcome-card" style="padding: 2rem 1.5rem;">

    <h1 style="color: var(--text-primary); margin-bottom: 20px; font-size: 2.5vh; flex-shrink: 0;">Create New Path</h1>

    <div class="welcome-form-wrapper">
      <%# The Rails form wrapper matches the styling of the wrapper div on other pages %>
      <%= form_with(model: @path) do |form| %>

        <% if @path.errors.any? %>
          <%# Using the shared error partial for consistency %>
          <%= render "devise/shared/error_messages", resource: @path %>
        <% end %>

        <div class="form-group">
          <%= form.text_field :name,
                              required: true,
                              placeholder: "Path Name (e.g. Deploy to Production)",
                              class: "welcome-input" %>
        </div>

        <div class="form-group">
          <label style="color: var(--text-secondary); font-size: 0.9rem;">When to notify?</label>
          <%= form.datetime_field :strike_time,
                                  required: true,
                                  class: "welcome-input",
                                  style: "color-scheme: dark; padding: 0.8rem 1.2rem;" %>
        </div>

        <div class="form-group">
          <label style="color: var(--text-secondary); font-size: 0.9rem;">Target Devices</label>

          <% if @devices.any? %>
            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 5px;">
              <% current_user.web_push_subscriptions.each do |sub| %>
                <label style="display: flex; align-items: center; gap: 10px; color: var(--text-primary); cursor: pointer;">
                  <%= check_box_tag "path[web_push_subscription_ids][]",
                                    sub.id,
                                    @path.web_push_subscription_ids.include?(sub.id),
                                    class: "welcome-input",
                                    style: "width: 20px; height: 20px; flex: 0 0 auto;" %>
                  <span><%= sub.device_name %></span>
                </label>
              <% end %>
            </div>
          <% else %>
            <p style="color: var(--text-muted); font-size: 0.85rem; margin-top: 5px; text-align: center;">
              <em>No devices registered.
                <%= link_to "Add one here", new_web_push_subscription_path, style: "color: var(--input-focus); font-weight: bold;" %>
              </em>
            </p>
          <% end %>
        </div>

        <div class="form-group">
          <label style="color: var(--text-secondary); font-size: 0.9rem;">Share with Friends</label>

          <% if @friends.any? %>
            <div style="display: flex; flex-direction: column; gap: 10px; margin-top: 5px;">
              <% @friends.each do |friend| %>
                <label style="display: flex; align-items: center; gap: 10px; color: var(--text-primary); cursor: pointer;">
                  <%= check_box_tag "path[shared_user_ids][]",
                                    friend.id,
                                    @path.shared_user_ids.include?(friend.id),
                                    class: "welcome-input",
                                    style: "width: 20px; height: 20px; flex: 0 0 auto;" %>
                  <span><%= friend.email %></span>
                </label>
              <% end %>
            </div>
          <% else %>
            <p style="color: var(--text-muted); font-size: 0.85rem; text-align: center;">
              <em>You have no mutual connections yet.</em>
            </p>
          <% end %>
        </div>

        <div class="welcome-buttons-container" style="margin-top: 20px;">
          <%= form.submit "CREATE PATH", class: "welcome-button solid-button" %>
          <%= link_to "BACK", paths_path, class: "welcome-button outline-button" %>
        </div>
      <% end %> <%# END OF MAIN FORM %>

      <%# ADD FRIEND FORM (Only visible if no friends, placed OUTSIDE main form to valid nesting) %>
      <% unless @friends.any? %>
        <div style="margin-top: 20px; border-top: 1px solid var(--card-border); padding-top: 20px;">
          <p style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 10px;">Add a friend to get started:</p>
          <%= form_with url: friendships_path, local: true, style: "display:flex; gap: 10px;" do |f| %>
            <%= f.email_field :email, placeholder: "Friend's Email", class: "welcome-input", style: "padding: 0.8rem;" %>
            <%= f.submit "ADD", class: "welcome-button solid-button", style: "flex: 0 0 auto; width: auto; padding: 0 1.5rem;" %>
          <% end %>
        </div>
      <% end %>

    </div>
  </div>
</div>