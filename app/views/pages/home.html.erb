<%# app/views/pages/home.html.erb - The authenticated dashboard %>

<% content_for :head do %>
  <%= stylesheet_link_tag "welcome", "data-turbo-track": "reload" %>
  <style>
      /* Custom styles for the home view within the theme */
      .dashboard-actions {
          display: flex;
          gap: 10px;
          margin-bottom: 20px;
          flex-shrink: 0;
      }
      .dashboard-actions .welcome-button {
          flex: 1;
          min-width: 0; /* Ensures buttons shrink on mobile */
      }

      .path-scroll-container {
          /* Takes up all available vertical space in the card (Flex Grow) */
          flex-grow: 1;
          /* Enables vertical scrolling when content exceeds container size */
          overflow-y: auto;
          /* Optional: Add space for the scrollbar to prevent overlapping with content */
          padding-right: 15px;
      }

      .welcome-card {
          /* CORE CHANGE: This ensures the card is constrained by the viewport and uses Flexbox */
          display: flex;
          flex-direction: column;
          height: 100%;
          max-height: 90vh; /* Limits the card height to prevent body scrolling */
          padding: 2rem 1.5rem;
          /* Internal padding */
          /* Note: The outer #welcome-screen container is responsible for centering the card */
      }

      /* List item styles */
      .path-list {
          display: flex;
          flex-direction: column;
          gap: 15px;
      }
      .path-item {
          padding: 15px;
          border: 1px solid var(--card-border);
          border-radius: 4px;
          background-color: rgba(0, 0, 0, 0.2);
          text-align: left;
      }
      .path-item strong {
          color: var(--text-primary);
          font-size: 1.1rem;
          display: block;
          margin-bottom: 5px;
      }
      .path-item small {
          color: var(--text-secondary);
          display: block;
          line-height: 1.4;
      }
      .path-actions {
          margin-top: 10px;
          display: flex;
          /* NEW/MODIFIED: Critical to spread content */
          justify-content: space-between;
          align-items: center;
      }
      .path-actions .welcome-button {
          padding: 0.5rem 0.8rem;
          font-size: 0.75rem;
          letter-spacing: 0.5px;
          text-transform: none;
      }
  </style>
<% end %>

<%# 1. Background animation %>
<canvas id="particle-canvas" data-controller="welcome-background"></canvas>

<div id="welcome-screen">
  <div class="welcome-card">
    <%# Header - flex-shrink: 0 ensures it doesn't compress %>
    <h1 style="color: var(--text-primary); margin-bottom: 20px; font-size: 2.5vh; flex-shrink: 0;">My Golden Paths</h1>

    <%# --- ACTION BUTTONS CONTAINER --- %>
    <div class="dashboard-actions">
      <%# Button to create a new Path %>
      <%= link_to "NEW PATH", new_path_path, class: "welcome-button solid-button" %>

      <%# Button to create a new Web Push Subscription (New Device) - Added %>
      <%= link_to "NEW DEVICE", new_web_push_subscription_path, class: "welcome-button outline-button" %>
    </div>
    <%# -------------------------------- %>

    <% if current_user.pending_requests.any? %>
      <div style="margin-bottom: 20px; padding: 15px; background: rgba(197, 160, 89, 0.1); border: 1px solid var(--input-focus); border-radius: 4px;">
        <h3 style="color: var(--input-focus); font-size: 1rem; margin-bottom: 10px;">Friend Requests</h3>

        <div style="display: flex; flex-direction: column; gap: 10px;">
          <% current_user.pending_requests.each do |requester| %>
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <span style="color: var(--text-primary); font-size: 0.9rem;"><%= requester.email %></span>

              <%# "Accept" is just adding them back %>
              <%= form_with url: friendships_path, local: true do |f| %>
                <%= f.hidden_field :email, value: requester.email %>
                <%= f.submit "ACCEPT", class: "welcome-button solid-button", style: "padding: 5px 15px; font-size: 0.7rem;" %>
              <% end %>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
    <%# === SCROLLABLE CONTAINER START === %>
    <div class="path-scroll-container">
      <% if @paths.any? %>
        <div class="path-list">
          <% @paths.each do |path| %>
            <div class="path-item">
              <strong><%= path.name %></strong>
              <small>Due: <%= path.strike_time.to_fs(:short) %></small>

              <%# FIXED: Support multiple devices in display %>
              <small>Devices:
                <% if path.web_push_subscriptions.any? %>
                  <%= path.web_push_subscriptions.map(&:device_name).join(", ") %>
                <% else %>
                  None
                <% end %>
              </small>

              <%# NEW/MODIFIED LOGIC BELOW %>
              <div class="path-actions">
                <% if path.user != current_user %>
                  <small style="color: var(--text-secondary); font-style: italic;">Shared by <%= path.user.email %></small>
                <% else %>
                  <span></span> <%# Empty span for spacing on owner's paths %>
                <% end %>

                <%# Button container for spacing the action buttons %>
                <div style="display: flex; gap: 10px;">

                  <% if path.user == current_user %>
                    <%# NEW: Mark as Done Button - Only visible to the owner %>
                    <%= button_to "Mark as Done", mark_as_done_path_path(path),
                                  method: :patch,
                                  class: "welcome-button solid-button",
                                  style: "background-color: #37D4AF; color: var(--btn-text); flex: 0 0 auto; min-width: 0;" %>
                  <% end %>

                  <%= button_to "Delete", path_path(path),
                                method: :delete,
                                data: { turbo_confirm: "Are you sure you want to delete this path?" },
                                class: "welcome-button outline-button",
                                style: "flex: 0 0 auto; min-width: 0;" %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <p style="color: var(--text-secondary); margin-top: 20px; font-size: 0.95rem;">
          You haven't created any paths yet. Click "NEW PATH" above to get started.
        </p>
      <% end %>
    </div>
    <%# === SCROLLABLE CONTAINER END === %>

    <%# Log Out Button - Fixed position at the bottom %>
    <div style="margin-top: 20px; flex-shrink: 0;">
      <%= link_to "Log Out", destroy_user_session_path,
                  class: "welcome-button outline-button",
                  style: "width: 100%; opacity: 0.7;",
                  data: { turbo_method: :delete } %>
    </div>
  </div>
</div>